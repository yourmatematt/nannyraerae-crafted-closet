<!DOCTYPE html>
<html>
<head>
    <title>Debug Complete Purchase Flow</title>
</head>
<body>
    <h1>Debug Complete Purchase Flow</h1>

    <div style="margin: 20px 0;">
        <h3>Step 1: Check Recent Orders</h3>
        <button onclick="checkRecentOrders()">Check Orders from Last Hour</button>
        <div id="orders-result"></div>
    </div>

    <div style="margin: 20px 0;">
        <h3>Step 2: Check Product Stock Status</h3>
        <button onclick="checkProductStock()">Check All Products Stock</button>
        <div id="products-result"></div>
    </div>

    <div style="margin: 20px 0;">
        <h3>Step 3: Check Webhook Endpoint</h3>
        <button onclick="testWebhookEndpoint()">Test Webhook Endpoint</button>
        <div id="webhook-result"></div>
    </div>

    <div style="margin: 20px 0;">
        <h3>Step 4: Simulate Webhook Call</h3>
        <button onclick="simulateWebhookCall()">Simulate Stripe Webhook</button>
        <div id="simulate-result"></div>
    </div>

    <div style="margin: 20px 0;">
        <h3>Step 5: Manual Order Creation</h3>
        <button onclick="createTestOrder()">Create Test Order + Update Stock</button>
        <div id="manual-result"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const supabase = window.supabase.createClient(
            'https://kqshrevhtrusxrwkgdmd.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtxc2hyZXZodHJ1c3hyd2tnZG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODQ0NDcsImV4cCI6MjA3NDI2MDQ0N30.797cTDtt67n9rtpSjOGOawf6od5ETfcfbAftiR3qkJs'
        );

        async function checkRecentOrders() {
            const result = document.getElementById('orders-result');
            result.innerHTML = '<p>Checking recent orders...</p>';

            try {
                const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();

                const { data: orders, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        order_items (*)
                    `)
                    .gte('created_at', oneHourAgo)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                result.innerHTML = `
                    <p><strong>Orders in last hour: ${orders.length}</strong></p>
                    ${orders.length > 0 ? `
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${orders.map(order => `
                                <div style="border: 1px solid #ccc; padding: 10px; margin: 5px;">
                                    <p><strong>ID:</strong> ${order.id.slice(-8)}</p>
                                    <p><strong>Email:</strong> ${order.customer_email}</p>
                                    <p><strong>Total:</strong> $${order.total}</p>
                                    <p><strong>Status:</strong> ${order.status}</p>
                                    <p><strong>Payment Intent:</strong> ${order.stripe_payment_intent_id}</p>
                                    <p><strong>Created:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: red;">❌ No orders found in last hour</p>'}
                `;

            } catch (error) {
                result.innerHTML = `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }

        async function checkProductStock() {
            const result = document.getElementById('products-result');
            result.innerHTML = '<p>Checking product stock...</p>';

            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('id, name, stock, is_active, updated_at')
                    .order('updated_at', { ascending: false });

                if (error) throw error;

                result.innerHTML = `
                    <p><strong>Products found: ${products.length}</strong></p>
                    <table border="1" style="border-collapse: collapse; width: 100%;">
                        <tr>
                            <th>Name</th>
                            <th>Stock</th>
                            <th>Active</th>
                            <th>Last Updated</th>
                        </tr>
                        ${products.map(p => `
                            <tr style="background-color: ${p.stock === 0 ? '#ffebee' : '#e8f5e8'}">
                                <td>${p.name}</td>
                                <td>${p.stock}</td>
                                <td>${p.is_active ? '✅' : '❌'}</td>
                                <td>${new Date(p.updated_at).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;

            } catch (error) {
                result.innerHTML = `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }

        async function testWebhookEndpoint() {
            const result = document.getElementById('webhook-result');
            result.innerHTML = '<p>Testing webhook endpoint...</p>';

            try {
                const response = await fetch('https://kqshrevhtrusxrwkgdmd.supabase.co/functions/v1/stripe-webhook', {
                    method: 'OPTIONS'
                });

                result.innerHTML = `
                    <p><strong>Webhook Endpoint Test:</strong></p>
                    <p>Status: ${response.status} ${response.statusText}</p>
                    <p>Reachable: ${response.ok ? '✅ Yes' : '❌ No'}</p>
                `;

            } catch (error) {
                result.innerHTML = `<p style="color: red;">❌ Webhook unreachable: ${error.message}</p>`;
            }
        }

        async function simulateWebhookCall() {
            const result = document.getElementById('simulate-result');
            result.innerHTML = '<p>Simulating webhook call...</p>';

            // This will fail due to signature verification, but it will show us if the endpoint accepts POST
            try {
                const response = await fetch('https://kqshrevhtrusxrwkgdmd.supabase.co/functions/v1/stripe-webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'stripe-signature': 'test-signature'
                    },
                    body: JSON.stringify({
                        type: 'payment_intent.succeeded',
                        data: { object: { id: 'pi_test123' } }
                    })
                });

                const responseText = await response.text();

                result.innerHTML = `
                    <p><strong>Webhook Simulation:</strong></p>
                    <p>Status: ${response.status}</p>
                    <p>Response: ${responseText}</p>
                    <p>Analysis: ${
                        response.status === 400 ? '✅ Webhook accepts POST but rejects invalid signature (expected)' :
                        response.status === 405 ? '❌ Webhook not accepting POST requests' :
                        response.status === 401 ? '⚠️ Authentication issue' :
                        '❓ Unexpected response'
                    }</p>
                `;

            } catch (error) {
                result.innerHTML = `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }

        async function createTestOrder() {
            const result = document.getElementById('manual-result');
            result.innerHTML = '<p>Creating manual test order...</p>';

            try {
                // Get first available product
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select('*')
                    .eq('is_active', true)
                    .gt('stock', 0)
                    .limit(1);

                if (productsError) throw productsError;
                if (!products || products.length === 0) {
                    throw new Error('No available products found');
                }

                const product = products[0];

                // Create order
                const orderData = {
                    customer_email: 'manual-test@example.com',
                    customer_first_name: 'Manual',
                    customer_last_name: 'Test',
                    customer_phone: '+61400000000',
                    shipping_address_line1: '123 Test Street',
                    shipping_city: 'Sydney',
                    shipping_state: 'NSW',
                    shipping_postcode: '2000',
                    shipping_country: 'AU',
                    subtotal: product.price,
                    shipping_cost: 0,
                    gst: product.price * 0.1,
                    total: product.price * 1.1,
                    stripe_payment_intent_id: 'pi_manual_' + Date.now(),
                    status: 'completed',
                    session_id: 'manual_' + Date.now()
                };

                const { data: order, error: orderError } = await supabase
                    .from('orders')
                    .insert(orderData)
                    .select()
                    .single();

                if (orderError) throw orderError;

                // Create order item (using correct column names)
                const { error: itemError } = await supabase
                    .from('order_items')
                    .insert({
                        order_id: order.id,
                        product_id: product.id,
                        product_name: product.name,
                        quantity: 1,
                        unit_price: product.price
                        // Removed total_price as it doesn't exist in schema
                    });

                if (itemError) throw itemError;

                // Update product stock
                const { error: stockError } = await supabase
                    .from('products')
                    .update({
                        stock: 0,
                        is_active: false
                    })
                    .eq('id', product.id);

                if (stockError) throw stockError;

                result.innerHTML = `
                    <p style="color: green;">✅ Manual test successful!</p>
                    <p><strong>Order ID:</strong> ${order.id}</p>
                    <p><strong>Product:</strong> ${product.name} (marked as sold)</p>
                    <p><strong>Check:</strong> <a href="/admin/orders" target="_blank">Admin Orders</a></p>
                `;

            } catch (error) {
                result.innerHTML = `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>Webhook Connectivity Test</title>
</head>
<body>
    <h1>Stripe Webhook Connectivity Test</h1>

    <div>
        <h3>Step 1: Test Webhook Endpoint</h3>
        <button onclick="testWebhookReachable()">Test If Webhook Endpoint is Reachable</button>
        <div id="connectivity-result"></div>
    </div>

    <div>
        <h3>Step 2: Send Test POST to Webhook</h3>
        <button onclick="sendTestPOST()">Send Test POST Request</button>
        <div id="post-result"></div>
    </div>

    <div>
        <h3>Step 3: Check Function Logs</h3>
        <button onclick="openFunctionLogs()">Open Supabase Function Logs</button>
    </div>

    <div>
        <h3>Step 4: Manual Order Creation Test</h3>
        <button onclick="createManualOrder()">Create Manual Order (Bypass Webhook)</button>
        <div id="manual-result"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const supabase = window.supabase.createClient(
            'https://kqshrevhtrusxrwkgdmd.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtxc2hyZXZodHJ1c3hyd2tnZG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODQ0NDcsImV4cCI6MjA3NDI2MDQ0N30.797cTDtt67n9rtpSjOGOawf6od5ETfcfbAftiR3qkJs'
        );

        async function testWebhookReachable() {
            const result = document.getElementById('connectivity-result');
            result.innerHTML = '<p>Testing webhook connectivity...</p>';

            try {
                // Test OPTIONS request (CORS preflight)
                const optionsResponse = await fetch('https://kqshrevhtrusxrwkgdmd.supabase.co/functions/v1/stripe-webhook', {
                    method: 'OPTIONS'
                });

                result.innerHTML = `
                    <p><strong>OPTIONS Request:</strong></p>
                    <p>Status: ${optionsResponse.status} ${optionsResponse.statusText}</p>
                    <p>Headers: ${JSON.stringify(Object.fromEntries(optionsResponse.headers.entries()), null, 2)}</p>
                `;

                if (optionsResponse.ok) {
                    result.innerHTML += '<p style="color: green;">✅ Webhook endpoint is reachable!</p>';
                } else {
                    result.innerHTML += '<p style="color: red;">❌ Webhook endpoint not reachable</p>';
                }

            } catch (error) {
                result.innerHTML = `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }

        async function sendTestPOST() {
            const result = document.getElementById('post-result');
            result.innerHTML = '<p>Sending test POST...</p>';

            try {
                // Send a test POST request (this should fail gracefully but show us if the endpoint accepts POST)
                const postResponse = await fetch('https://kqshrevhtrusxrwkgdmd.supabase.co/functions/v1/stripe-webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'stripe-signature': 'test-signature'
                    },
                    body: JSON.stringify({
                        type: 'test',
                        data: { test: true }
                    })
                });

                const responseText = await postResponse.text();

                result.innerHTML = `
                    <p><strong>POST Request Result:</strong></p>
                    <p>Status: ${postResponse.status} ${postResponse.statusText}</p>
                    <p>Response: ${responseText}</p>
                `;

                if (postResponse.status === 405) {
                    result.innerHTML += '<p style="color: red;">❌ Still getting 405 - webhook not accepting POST</p>';
                } else if (postResponse.status === 400) {
                    result.innerHTML += '<p style="color: orange;">⚠️ 400 error - webhook is accepting POST but rejecting our test data (this is expected)</p>';
                } else {
                    result.innerHTML += '<p style="color: green;">✅ Webhook is accepting POST requests</p>';
                }

            } catch (error) {
                result.innerHTML = `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }

        function openFunctionLogs() {
            window.open('https://supabase.com/dashboard/project/kqshrevhtrusxrwkgdmd/functions/stripe-webhook', '_blank');
        }

        async function createManualOrder() {
            const result = document.getElementById('manual-result');
            result.innerHTML = '<p>Creating manual order...</p>';

            try {
                // Get a product first
                const { data: products, error: productError } = await supabase
                    .from('products')
                    .select('*')
                    .limit(1);

                if (productError) throw productError;
                if (!products || products.length === 0) {
                    throw new Error('No products found');
                }

                const product = products[0];

                // Create order manually with correct field names
                const orderData = {
                    customer_email: 'test@example.com',
                    customer_first_name: 'Test',
                    customer_last_name: 'Customer',
                    customer_phone: '+61400000000',
                    shipping_address_line1: '123 Test Street',
                    shipping_address_line2: 'Apartment 4B',
                    shipping_city: 'Sydney',
                    shipping_state: 'NSW',
                    shipping_postcode: '2000',
                    shipping_country: 'AU',
                    subtotal: product.price,
                    shipping_cost: 0,
                    gst: 0,
                    total: product.price,
                    stripe_payment_intent_id: 'pi_manual_test_' + Date.now(),
                    status: 'completed',
                    session_id: 'manual_test_' + Date.now()
                };

                console.log('Creating order with data:', orderData);

                const { data: order, error: orderError } = await supabase
                    .from('orders')
                    .insert(orderData)
                    .select()
                    .single();

                if (orderError) {
                    console.error('Order creation error:', orderError);
                    throw orderError;
                }

                console.log('Order created:', order);

                // Create order item
                const itemData = {
                    order_id: order.id,
                    product_id: product.id,
                    product_name: product.name,
                    quantity: 1,
                    unit_price: product.price,
                    total_price: product.price
                };

                console.log('Creating order item with data:', itemData);

                const { error: itemError } = await supabase
                    .from('order_items')
                    .insert(itemData);

                if (itemError) {
                    console.error('Order item creation error:', itemError);
                    throw itemError;
                }

                // Update product stock
                const { error: stockError } = await supabase
                    .from('products')
                    .update({
                        stock: 0,
                        is_active: false
                    })
                    .eq('id', product.id);

                if (stockError) {
                    console.error('Stock update error:', stockError);
                    throw stockError;
                }

                result.innerHTML = `
                    <p style="color: green;">✅ Manual order created successfully!</p>
                    <p>Order ID: ${order.id}</p>
                    <p>Product: ${product.name} (marked as sold)</p>
                    <p><strong>Now check:</strong></p>
                    <ul>
                        <li><a href="/admin/orders" target="_blank">Admin Orders Page</a></li>
                        <li><a href="/admin/products" target="_blank">Admin Products Page</a></li>
                    </ul>
                `;

            } catch (error) {
                console.error('Manual order creation failed:', error);
                result.innerHTML = `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
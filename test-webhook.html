<!DOCTYPE html>
<html>
<head>
    <title>Test Stripe Webhook</title>
</head>
<body>
    <h1>Test Stripe Webhook</h1>
    <button onclick="testWebhookEndpoint()">Test Webhook Endpoint</button>
    <button onclick="manuallyCreateOrder()">Manually Create Test Order</button>
    <div id="results"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const supabase = window.supabase.createClient(
            'https://kqshrevhtrusxrwkgdmd.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtxc2hyZXZodHJ1c3hyd2tnZG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODQ0NDcsImV4cCI6MjA3NDI2MDQ0N30.797cTDtt67n9rtpSjOGOawf6od5ETfcfbAftiR3qkJs'
        );

        async function testWebhookEndpoint() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Testing webhook endpoint...</p>';

            try {
                // Test if webhook endpoint responds
                const response = await fetch('https://kqshrevhtrusxrwkgdmd.supabase.co/functions/v1/stripe-webhook', {
                    method: 'OPTIONS'
                });

                if (response.ok) {
                    results.innerHTML = `<p style="color: green;">✅ Webhook endpoint is reachable</p>`;
                } else {
                    results.innerHTML = `<p style="color: red;">❌ Webhook endpoint returned: ${response.status}</p>`;
                }
            } catch (error) {
                results.innerHTML = `<p style="color: red;">❌ Error reaching webhook: ${error.message}</p>`;
            }
        }

        async function manuallyCreateOrder() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Creating test order...</p>';

            try {
                // First, get a product to create an order for
                const { data: products, error: productError } = await supabase
                    .from('products')
                    .select('*')
                    .limit(1);

                if (productError) throw productError;
                if (!products || products.length === 0) {
                    throw new Error('No products found to create order');
                }

                const product = products[0];

                // Create order
                const { data: order, error: orderError } = await supabase
                    .from('orders')
                    .insert({
                        shipping_address_line1: '123 Test St',
                        shipping_address_line2: 'Unit 5',
                        shipping_city: 'Sydney',
                        shipping_state: 'NSW',
                        shipping_postcode: '2000',
                        shipping_country: 'AU',
                        subtotal: product.price,
                        shipping_cost: 0,
                        tax_amount: 0,
                        total: product.price,
                        stripe_payment_intent_id: 'pi_test_manual_' + Date.now(),
                        status: 'pending'
                    })
                    .select()
                    .single();

                if (orderError) throw orderError;

                // Create order item
                const { error: itemError } = await supabase
                    .from('order_items')
                    .insert({
                        order_id: order.id,
                        product_id: product.id,
                        product_name: product.name,
                        product_price: product.price,
                        quantity: 1,
                        product_image: product.image_url
                    });

                if (itemError) throw itemError;

                // Update product stock
                const { error: stockError } = await supabase
                    .from('products')
                    .update({
                        stock: 0,
                        is_active: false
                    })
                    .eq('id', product.id);

                if (stockError) throw stockError;

                results.innerHTML = `
                    <p style="color: green;">✅ Test order created successfully!</p>
                    <p>Order ID: ${order.id}</p>
                    <p>Product updated: ${product.name}</p>
                    <p>Check /admin/orders to see the order</p>
                `;

            } catch (error) {
                results.innerHTML = `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>